<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Managing Audio Devices with Electron</title>
    <style>
      label {
        display: block;
        margin-bottom: 1em;
      }

      audio {
        display: block;
        width: 100%;
        margin-top: 2em;
      }
    </style>
  </head>
  <body>
    <h1>Demo 4 - getUserMedia</h1>

    <label>
      Input device
      <select id="input-device-selector"></select>
    </label>

    <label>
      Output device
      <select id="output-device-selector"></select>
    </label>

    <button id="start-capture">Start capture</button>

    <audio id="audio-player" controls autoplay></audio>
  </body>

  <script>
  const inputDeviceSelector = document.getElementById('input-device-selector')
  const outputDeviceSelector = document.getElementById('output-device-selector')
  const audioElement = document.getElementById('audio-player')

  const refreshDevices = function() {
    navigator.mediaDevices.enumerateDevices()
      .then((devices) => {
        inputDeviceSelector.innerHTML = null
        outputDeviceSelector.innerHTML = null

        devices.forEach((device) => {
          if (!device.kind.includes('audio')) return
          const option = document.createElement('option')
          option.value = device.deviceId
          option.textContent = device.label;
          (device.kind.includes('input') ? inputDeviceSelector : outputDeviceSelector).add(option)
        })

        audioElement.setSinkId(null)
        audioElement.srcObject = null
      })
  }

  refreshDevices()

  navigator.mediaDevices.addEventListener('devicechange', refreshDevices)

  document.getElementById('start-capture').addEventListener('click', () => {
    const selectedInputId = inputDeviceSelector.options[inputDeviceSelector.selectedIndex].value
    const selectedOutputId = outputDeviceSelector.options[outputDeviceSelector.selectedIndex].value

    const constraints = {
      audio: {
        deviceId: selectedInputId
      },
      video: false
    }

    Promise.all([
      navigator.mediaDevices.getUserMedia(constraints),
      audioElement.setSinkId(selectedOutputId)
    ])
    .then((resolvedValues) => {
      const stream = resolvedValues[0]
      audioElement.srcObject = stream
    })
    .catch((err) => console.error(err))
  })
  </script>
</html>
